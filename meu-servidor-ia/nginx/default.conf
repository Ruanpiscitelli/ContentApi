# Adicionar no início do arquivo, antes do bloco server
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=10g inactive=60m use_temp_path=off;

server {
    listen 80;
    server_name contentapi.ruanpiscitelli.com;  # Substitua pelo seu domínio real ou IP público

    # Cabeçalhos comuns para encaminhar informações do cliente aos serviços
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Rota para o Dashboard Administrativo
    location /dashboard/ {
        proxy_pass http://dashboard:8000/;
    }

    # Rota para a geração de imagens (SDXL/Flux + LoRAs)
    location /generate-image/ {
        proxy_pass http://image_generator:8000/;
        
        # Configurações de cache
        proxy_cache api_cache;
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        proxy_cache_valid 200 60m;
        add_header X-Cache-Status $upstream_cache_status;
        
        # Headers de cache
        add_header Cache-Control "public, max-age=3600";
        add_header Vary "Accept-Encoding";
        
        # Configurações de timeout
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;
        
        # Configurações de buffer
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    # Rota para a geração de voz (síntese básica)
    location /generate-voice/ {
        proxy_pass http://voice_generator:8000/;
        proxy_cache api_cache;
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        proxy_cache_valid 200 30m;
        add_header X-Cache-Status $upstream_cache_status;
        add_header Cache-Control "public, max-age=1800";
        add_header Vary "Accept-Encoding";
    }

    # Rota para a clonagem de voz
    location /clone-voice/ {
        proxy_pass http://voice_generator:8000/;
    }

    # Rota para a geração de vídeo (Hunyuan)
    location /generate-video/ {
        proxy_pass http://video_generator:8000/;
    }

    # Rota para a edição de vídeo (JSON, estilo json2video)
    location /edit-video/ {
        proxy_pass http://video_editor:8000/;
    }
}