<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Meu Servidor de IA</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #2d2d2d;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #fb5607;
            font-size: 2.5em;
            margin-bottom: 30px;
            border-bottom: 3px solid #3a86ff;
            padding-bottom: 10px;
            display: inline-block;
        }
        a {
            color: #fb5607;
            text-decoration: none;
            float: right;
            font-weight: bold;
            transition: color 0.3s;
        }
        a:hover {
            color: #3a86ff;
        }
        h2 {
            color: #fb5607;
            margin-top: 30px;
            font-size: 1.8em;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            background-color: #333333;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .status-card h3 {
            color: #3a86ff;
            margin-top: 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok {
            background-color: #4CAF50;
        }
        .status-error {
            background-color: #f44336;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background-color: #333333;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-card h3 {
            color: #3a86ff;
            margin-top: 0;
        }
        .metric-value {
            font-size: 2em;
            color: #fb5607;
            margin: 10px 0;
        }
        .terminal {
            background-color: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid #333;
        }
        .terminal div {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        .terminal div:hover {
            background-color: #2a2a2a;
        }
        .terminal::-webkit-scrollbar {
            width: 8px;
        }
        .terminal::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        .terminal::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        .terminal::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        .chart-container {
            background-color: #333333;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            height: 400px;
        }
        button {
            background-color: #fb5607;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        button:hover {
            background-color: #3a86ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(251, 86, 7, 0.4);
        }
        .api-keys {
            background-color: #333333;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
        }
        .gpu-card {
            grid-column: span 2;
        }
        .gpu-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .gpu-metric {
            text-align: left;
            padding: 5px;
            border-radius: 4px;
            background-color: #2a2a2a;
        }
        .gpu-metric .label {
            color: #3a86ff;
            font-size: 0.9em;
            display: block;
            margin-bottom: 3px;
        }
        .gpu-metric .value {
            color: #fb5607;
            font-size: 1.1em;
            font-weight: bold;
        }
        .gpu-error {
            color: #ff4444;
            font-weight: bold;
        }
        .error-message {
            color: #ff4444;
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #333;
            font-family: monospace;
        }
        .log-error {
            color: #ff4444;
            background-color: rgba(255, 68, 68, 0.1);
        }
        .log-warning {
            color: #ffbb33;
            background-color: rgba(255, 187, 51, 0.1);
        }
        .gpu-error {
            background-color: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
        }
        .text-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
        }
        .text-metrics .metric-item {
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/charts.js"></script>
</head>
<body>
    <div class="container">
        <h1>Dashboard</h1>
        <a href="/logout">Logout</a>

        <h2>Status dos Serviços</h2>
        <div class="status-grid">
            {% for service, status in services_status.items() %}
            <div class="status-card">
                <h3>{{ service }}</h3>
                <span class="status-indicator {% if status == 'OK' %}status-ok{% else %}status-error{% endif %}"></span>
                {{ status }}
            </div>
            {% endfor %}
        </div>

        <h2>Métricas do Sistema</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>CPU</h3>
                <div id="cpu-usage" class="metric-value">{{ metrics.cpu }}</div>
            </div>
            <div class="metric-card">
                <h3>Memória</h3>
                <div id="memory-usage" class="metric-value">{{ metrics.memory }}</div>
            </div>
            <div class="metric-card">
                <h3>Text Generator</h3>
                <div class="text-metrics">
                    <div class="metric-item">
                        <span class="label">Latência:</span>
                        <span id="text-latency" class="value">0ms</span>
                    </div>
                    <div class="metric-item">
                        <span class="label">Taxa de Erros:</span>
                        <span id="text-error-rate" class="value">0%</span>
                    </div>
                    <div class="metric-item">
                        <span class="label">Cache Hit Rate:</span>
                        <span id="text-cache-rate" class="value">0%</span>
                    </div>
                    <div class="metric-item">
                        <span class="label">Tokens/min:</span>
                        <span id="text-tokens" class="value">0</span>
                    </div>
                </div>
            </div>
            {% for gpu_id, gpu_data in metrics.gpu.items() %}
            {% if gpu_data is mapping %}
            <div id="{{ gpu_id }}-container" class="metric-card gpu-card">
                <h3>{{ gpu_id }}</h3>
                {% if gpu_data.status == "OK" %}
                <div class="gpu-metrics">
                    <div class="gpu-metric">
                        <span class="label">Utilização:</span>
                        <span id="{{ gpu_id }}-utilization" class="value">{{ gpu_data.utilization }}%</span>
                    </div>
                    <div class="gpu-metric">
                        <span class="label">Memória:</span>
                        <span id="{{ gpu_id }}-memory" class="value">{{ gpu_data.memory.used }}MB / {{ gpu_data.memory.total }}MB ({{ gpu_data.memory.percent }}%)</span>
                    </div>
                    <div class="gpu-metric">
                        <span class="label">Temperatura:</span>
                        <span id="{{ gpu_id }}-temp" class="value">{{ gpu_data.temperature }}°C</span>
                    </div>
                    <div class="gpu-metric">
                        <span class="label">Potência:</span>
                        <span id="{{ gpu_id }}-power" class="value">{{ gpu_data.power_usage }}W</span>
                    </div>
                    <div class="gpu-metric">
                        <span class="label">Clock:</span>
                        <span id="{{ gpu_id }}-clock" class="value">{{ gpu_data.sm_clock }}MHz</span>
                    </div>
                    <div class="gpu-metric">
                        <span class="label">Processos:</span>
                        <span id="{{ gpu_id }}-processes" class="value">{{ gpu_data.processes }}</span>
                    </div>
                </div>
                {% else %}
                <div class="gpu-error">
                    <span id="{{ gpu_id }}-error" class="error-message">{{ gpu_data.error }}</span>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div id="{{ gpu_id }}-container" class="metric-card">
                <h3>{{ gpu_id }}</h3>
                <div id="{{ gpu_id }}-usage" class="metric-value">{{ gpu_data }}</div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <h2>Logs em Tempo Real</h2>
        <div class="terminal-container">
            <div id="logs" class="terminal">
                <div class="log-header">Iniciando monitoramento de logs...</div>
            </div>
        </div>

        <h2>Gráfico de Métricas</h2>
        <div class="chart-container">
            <canvas id="metricsChart"></canvas>
        </div>

        <h2>Gerenciamento de API Keys</h2>
        <div class="api-keys">
            <form method="post" action="/generate-api-key">
                <button type="submit">Gerar Nova API Key</button>
            </form>
            {% if api_key %}
            <p style="color:green">Nova API Key gerada: {{ api_key }}</p>
            {% endif %}
            <h3>API Keys Ativas</h3>
            <ul>
                {% for key in all_api_keys %}
                <li>{{ key }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <script>
        let metricsChart;
        const MAX_DATA_POINTS = 100;
        const eventSource = new EventSource('/api/logs_stream');

        // Inicialização do gráfico
        function initChart() {
            const ctx = document.getElementById('metricsChart').getContext('2d');
            metricsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU (%)',
                        borderColor: '#fb5607',
                        data: []
                    }, {
                        label: 'Memória (GB)',
                        borderColor: '#3a86ff',
                        data: []
                    }]
                },
                options: {
                    animation: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    elements: {
                        point: {
                            radius: 0
                        }
                    }
                }
            });
        }

        // Atualização do gráfico com limite de pontos
        function updateChart(data) {
            const timestamp = new Date().toLocaleTimeString();
            
            metricsChart.data.labels.push(timestamp);
            metricsChart.data.datasets[0].data.push(data.cpu);
            metricsChart.data.datasets[1].data.push(data.memory);

            if (metricsChart.data.labels.length > MAX_DATA_POINTS) {
                metricsChart.data.labels.shift();
                metricsChart.data.datasets.forEach(dataset => dataset.data.shift());
            }

            metricsChart.update('none'); // Desativa animação para melhor performance
        }

        // Atualização das métricas GPU
        function updateGPUMetrics(gpuData) {
            Object.entries(gpuData).forEach(([gpuId, data]) => {
                const container = document.getElementById(`${gpuId}-container`);
                if (!container) return;

                if (data.status === 'OK') {
                    document.getElementById(`${gpuId}-utilization`).textContent = `${data.utilization}%`;
                    document.getElementById(`${gpuId}-memory`).textContent = 
                        `${data.memory.used.toFixed(0)}MB / ${data.memory.total.toFixed(0)}MB (${data.memory.percent.toFixed(1)}%)`;
                    document.getElementById(`${gpuId}-temp`).textContent = `${data.temperature}°C`;
                    document.getElementById(`${gpuId}-power`).textContent = `${data.power_usage.toFixed(1)}W`;
                    container.classList.remove('gpu-error');
                } else {
                    container.classList.add('gpu-error');
                    document.getElementById(`${gpuId}-error`).textContent = data.error || 'GPU indisponível';
                }
            });
        }

        // Gerenciamento de logs
        function appendLog(message, level = 'INFO') {
            const logsContainer = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level.toLowerCase()}`;
            logEntry.textContent = message;
            
            logsContainer.appendChild(logEntry);
            if (logsContainer.childNodes.length > MAX_DATA_POINTS) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
            
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // Event Source Handlers
        eventSource.addEventListener('log', function(event) {
            try {
                const data = JSON.parse(event.data);
                appendLog(`${data.timestamp} - ${data.message}`, data.level);
            } catch (error) {
                console.error('Erro ao processar log:', error);
            }
        });

        eventSource.addEventListener('metrics', function(event) {
            try {
                const data = JSON.parse(event.data);
                updateGPUMetrics(data.gpu);
            } catch (error) {
                console.error('Erro ao processar métricas:', error);
            }
        });

        eventSource.onerror = function(error) {
            console.error('EventSource failed:', error);
            appendLog('Conexão com servidor perdida. Tentando reconectar...', 'ERROR');
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            
            // Atualização periódica das métricas gerais
            setInterval(async () => {
                try {
                    const response = await fetch('/api/metrics');
                    const data = await response.json();
                    updateChart(data);
                } catch (error) {
                    console.error('Erro ao atualizar métricas:', error);
                }
            }, 1000);
        });

        // Limpeza ao fechar a página
        window.addEventListener('beforeunload', () => {
            eventSource.close();
            if (metricsChart) {
                metricsChart.destroy();
            }
        });

        function updateMetrics(data) {
            // Atualiza métricas existentes
            document.getElementById('cpu-usage').textContent = `${data.cpu}%`;
            document.getElementById('memory-usage').textContent = `${data.memory} GB`;

            // Atualiza métricas do text generator
            if (data.text_generator) {
                document.getElementById('text-latency').textContent = `${data.text_generator.latency.toFixed(2)}ms`;
                document.getElementById('text-error-rate').textContent = `${data.text_generator.error_rate.toFixed(2)}%`;
                document.getElementById('text-cache-rate').textContent = `${data.text_generator.cache_hit_rate.toFixed(2)}%`;
                document.getElementById('text-tokens').textContent = data.text_generator.tokens_per_minute;
            }

            // Atualiza métricas GPU
            updateGPUMetrics(data.gpu);
        }
    </script>
</body>
</html>

